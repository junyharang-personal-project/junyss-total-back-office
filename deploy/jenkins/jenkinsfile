def SET_VARIABLE = "Jenkins File ë³€ìˆ˜ ì„¤ì •"
def SONARQUBE_ANALYSIS = "ì†Œë‚˜íë¸Œ Analysis í™•ì¸"
def SONARQUBE_QUALITY_GATE = "ì†Œë‚˜íë¸Œ Quality Gate í™•ì¸"
def APPLICATION_NAME = "total-back-office"

// git í™˜ê²½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
def get_commit_message() {  // git Commit Message ê°€ì ¸ì˜¤ê¸°
    script {
        return sh(script: "git show -s --format=%B ${env.GIT_COMMIT}", returnStdout: true).trim().replace(' ', '-spc-')
    }
}

def get_commit_author() {   // git commit ì‘ì„±ì ê°€ì ¸ì˜¤ê¸°
    script {
        return sh(script: "git --no-pager show -s --format=%an ${env.GIT_COMMIT}", returnStdout: true).trim()
    }
}

pipeline {
    agent any
    environment {
        DISCORD_WEBHOOK_URL = credentials("Total-Back-Office-BE-Discord-Webhook")
    }
    stages {
        stage(SET_VARIABLE) {
            steps {
                script {
                    // êµ¬ë™ í™˜ê²½ ì„¤ì • (ì‚¼í•­ ì—°ì‚°ìë¡œ ë¸ŒëŸ°ì¹˜ ì´ë¦„ì´ masterë¼ë©´ prod í™˜ê²½ì´ê³ , ì•„ë‹ˆë©´ dev í™˜ê²½
                    DRIVE_ENV = env.BRANCH_NAME.equals("master") ? "prod" : "dev"
                    APPLICATON_CREDENTIAL_NAME = DRIVE_ENV + APPLICATION_NAME + "-was"
                    // credential idëŠ” prod-was, dev-wasì—¬ì•„ í•œë‹¤.

                    // ë„ì»¤ ê´€ë ¨ ì„¤ì •
                    DOCKER_FILE_PATH = "./deploy/docker/Dockerfile"
                    DOCKER_IMAGE_NAME = "giggal-people/" + DRIVE_ENV + "-" + APPLICATON_CREDENTIAL_NAME

                    // gitea í™˜ê²½ ì„¤ì •
                    GITEA_CREDENTIAL_ID = "[ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤]gitea-backend"
                    GITEA_REPOSITORY_URL = "http://192.168.20.3:81/giggals-s-people/TotalBackOffice-BackEnd.git"

                    GIT_COMMIT_AUTHOR = get_commit_author()
                    GIT_COMMIT_MESSAGE = get_commit_message()

                    PR_ID = 'PRì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ìš”.'
                    PR_BRANCH = 'PRì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ìš”.'
                    if ("${GIT_COMMIT_MESSAGE}".contains('Merge')) {
                        PR_ID = "${GIT_COMMIT_MESSAGE}".substring("${GIT_COMMIT_MESSAGE}".indexOf('#') + 1, "${GIT_COMMIT_MESSAGE}".indexOf(')')).trim();
                        PR_BRANCH = "${GIT_COMMIT_MESSAGE}".split("from")[1].split("into")[0].trim();
                    }

                    // ì†Œë‚˜íë¸Œ ì„¤ì •
                    SONARQUBE_SERVER_NAME = 'SonarQube_BackEnd'
                    SONARQUBE_CREDENTIAL_ID = "backend-total-back-office"

                    // TEST Coverage Report Path
                    JUNIT_REPORT_PATH = "build/test-results/test"
                    JACOCO_REPORT_PATH = "build/jacoco/jacoco.xml"
                    CHECKSTYLE_REPORT_PATH = "build/reports/checkstyle-output/checkstyle-report.xml"

                    DISCORD_SEND_MESSAGE_TITLE = "ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤ í†µí•© ê´€ë¦¬ ì„œë¹„ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬"

                    DOCKER_SERVER_BASE_DIRECTORY = "/data/deploy/giggal-total-back-office"
                }
            }

            post {
                success {
                    sendStartAlarmToDiscord()
                }
            }
        } // stage(SET_VARIABLE) ë

        stage('GITEA CHECKOUT') {
            steps {
                echo "Repository Clone ì‘ì—…ì´ ì‹œì‘ ë˜ì—ˆì–´ìš” ğŸ˜€"

                git branch: "${env.BRANCH_NAME}",
                        credentialsId: GITEA_CREDENTIAL_ID,
                        url: GITEA_REPOSITORY_URL
            }

            post {
                success {
                    sendSuccessAlarmToDiscord('GITEA CHECKOUT')
                }

                failure {
                    sendFailedAlarmToDiscord('GITEA CHECKOUT')
                }
            } // Discord Send Post ë
        } // stage('GITEA CHECKOUT') ë

        stage('ë‚´ë¶€ Port ë²ˆí˜¸ ì¶”ì¶œ ë° ì›ê²© ì„œë²„ ì „ë‹¬ ì‘ì—…') {
            steps {
                script {
                    INTERNAL_PORT = sh(script: "yq e '.server.port' ./src/main/resources/application-${DRIVE_ENV}-port.yml", returnStdout: true).trim();
                }
            }

            post {
                success {
                    sendSuccessAlarmToDiscord('ë‚´ë¶€ Port ë²ˆí˜¸ ì¶”ì¶œ ë° ì›ê²© ì„œë²„ ì „ë‹¬ ì‘ì—…')
                }

                failure {
                    sendFailedAlarmToDiscord('ë‚´ë¶€ Port ë²ˆí˜¸ ì¶”ì¶œ ë° ì›ê²© ì„œë²„ ì „ë‹¬ ì‘ì—…')
                }
            } // Discord Send Post ë
        } // stage('ë‚´ë¶€ Port ë²ˆí˜¸ ì¶”ì¶œ ë° ì›ê²© ì„œë²„ ì „ë‹¬ ì‘ì—…') ë

        stage('Project Build ì‘ì—…') {
            steps {
                sh '''
                    echo 'Project Build ì‘ì—…ì„ ì‹œì‘ í•©ë‹ˆë‹¤!'
                    ./gradlew clean build --stacktrace --warning-mode all --info
                '''
            }

            post {
                success {
                    sendSuccessAlarmToDiscord('Project Build ì‘ì—…')
                }

                failure {
                    sendFailedAlarmToDiscord('Project Build ì‘ì—…')
                }
            } // Discord Send Post ë
        } // stage('Project Build ì‘ì—…') ë

        stage(SONARQUBE_ANALYSIS) {
            when {
                branch pattern: "(develop|master)", comparator: "REGEXP"
            }

            steps {
                script {
                    def scannerHome = tool 'SonarQube-Scanner';
                    withSonarQubeEnv(credentialsId: SONARQUBE_CREDENTIAL_ID, installationName: SONARQUBE_SERVER_NAME) {
                        sh "${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=BE-total-back-office \
                        -Dsonar.projectName=BE-total-back-office \
                        -Dsonar.branch.name=master \
                        -Dsonar.language=java \
                        -Dsonar.java.source=1.8 \
                        -Dsonar.sources=src/main/java \
                        -Dsonar.test=src/test/java \
                        -Dsonar.test.inclusion=**/*Test.java \
                        -Dsonar.issuesReport.console.enable=true \
                        -Dsonar.junit.reportPaths=${JUNIT_REPORT_PATH} \
                        -Dsonar.java.binaries=build/classes \
                        -Dsonar.java.coveragePlugin=jacoco \
                        -Dsonar.coverage.jacoco.xmlReportPaths=${JACOCO_REPORT_PATH} \
                        -Dsonar.java.libraries.empty=true \
                        -Dsonar.sourceEncoding=UTF-8 \
                        -Dsonar.java.checkstyle.reportPaths=${CHECKSTYLE_REPORT_PATH} \
                        -Dsonar.exclusions=**/dto/**,**/exception/**,**/constant/**,**/SpringInitProjectApplication.java,**/WebRestController.java,**/FileUploadYaml.java \
                        "
                    }
                }
            }

            post {
                success {
                    sendSuccessAlarmToDiscord(SONARQUBE_ANALYSIS)
                }

                failure {
                    sendFailedAlarmToDiscord(SONARQUBE_ANALYSIS)
                }
            } // Discord Send Post ë
        } // stage(SONARQUBE_ANALYSIS) ë

        stage(SONARQUBE_QUALITY_GATE) {
            when {
                branch pattern: "(develop|master)", comparator: "REGEXP"
            }

            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                    script {
                        echo "ì†Œë‚˜íë¸Œ Quality Gate ê²€ì‚¬ê°€ ì‹œì‘ ë˜ì—ˆì–´ìš”!"
                        def sonarQubeQualityGate = waitForQualityGate()
                        def qualityGateStatus = sonarQubeQualityGate.status
                        echo "Quality Gate ìƒíƒœ: ${qualityGateStatus}"

                        if (qualityGateStatus != 'OK') {
                            echo "Quality Gate ê²€ì¦ ìƒíƒœ: ${qualityGateStatus}"
                            error "Quality Gate ê²€ì¦ì— ì‹¤íŒ¨ í•˜ì˜€ì–´ìš” ğŸ˜­: ${qualityGateStatus}"

                        } else {
                            echo "Quality Gate ê²€ì¦ì— ì„±ê³µ í•˜ì˜€ì–´ìš” ğŸ˜€: ${qualityGateStatus}"
                        }

                        echo "Quality Gate ê²€ì¦ì„ ëª¨ë‘ ì™„ë£Œ í•˜ì˜€ì–´ìš” ğŸ˜"
                    }
                }
            }

            post {
                success {
                    sendSuccessAlarmToDiscord(SONARQUBE_QUALITY_GATE)
                }

                failure {
                    sendFailedAlarmToDiscord(SONARQUBE_QUALITY_GATE)
                }
            } // Discord Send Post ë
        } // stage(SONARQUBE_QUALITY_GATE) ë

        stage('Application ì„œë²„ì— File ì „ë‹¬') {
            steps([$class: "BapSshPromotionPublisherPlugin"]) {
                script {
                    sshPublisher(
                            publishers: [
                                    sshPublisherDesc(
                                            configName: "op-management-api",
                                            verbose: true,
                                            transfers: [
                                                    sshTransfer(
//                                                            remoteDirectory:"/data/deploy/giggal-total-back-office",
                                                            sourceFiles: "deploy/**",
                                                            execCommand: "chmod +x $DOCKER_SERVER_BASE_DIRECTORY/deploy/shell-script/deploy.sh"
                                                    ),
                                                    sshTransfer(
                                                            execCommand: "export INTERNAL_PORT=${INTERNAL_PORT}; \
                                                                          export DOCKER_IMAGE_NAME=${DOCKER_IMAGE_NAME}; \
                                                                          export OPERATION_ENV=${OPERATION_ENV}; \
                                                                          export EXTERNAL_BLUE_A_PORT=${env.EXTERNAL_BLUE_A_PORT}; \
                                                                          export EXTERNAL_BLUE_B_PORT=${env.EXTERNAL_BLUE_B_PORT}; \
                                                                          export EXTERNAL_GREEN_A_PORT=${env.EXTERNAL_GREEN_A_PORT}; \
                                                                          export EXTERNAL_GREEN_B_PORT=${env.EXTERNAL_GREEN_B_PORT}; \
                                                                          $DOCKER_SERVER_BASE_DIRECTORY/deploy/shell-script/deploy.sh"
                                                    )
                                            ]
                                    )
                            ]
                    )
                }
            }

            post {
                success {
                    sendSuccessAlarmToDiscord('Application ì„œë²„ì— File ì „ë‹¬')
                }

                failure {
                    sendFailedAlarmToDiscord('Application ì„œë²„ì— File ì „ë‹¬')
                }
            } // Discord Send Post ë
        } // stage('Application ì„œë²„ì— File ì „ë‹¬') ë

        stage('Application ì„œë²„ ë°°í¬ ì‘ì—…') {
            steps([$class: "BapSshPromotionPublisherPlugin"]) {
                script {
                    sshPublisher(
                            sshPublisherDesc(
                                    configName: "op-management-api",
                                    verbose: true,
                                    transfers: [
                                            sshTransfer(
                                                    execCommand: "$DOCKER_SERVER_BASE_DIRECTORY/deploy/shell-script/deploy.sh"
                                            )
                                    ]
                            )
                    )
                }
            }

            post {
                success {
                    sendSuccessAlarmToDiscord('Application ì„œë²„ ë°°í¬ ì‘ì—…')
                }

                failure {
                    sendFailedAlarmToDiscord('Application ì„œë²„ ë°°í¬ ì‘ì—…')
                }
            } // Discord Send Post ë
        } // stage("Application ì„œë²„ ë°°í¬ ì‘ì—…") ë

        stage('Jenkins CI/CD ì‘ì—… ì™„ë£Œ') {
            steps {
                sh 'echo "Jenkins CI/CD ì‘ì—…ì´ ì™„ë£Œ ë˜ì—ˆì–´ìš”. ğŸ˜"'
            }

            post {
                success {
                    sendEndSuccessAlarmToDiscord()
                }

                failure {
                    sendEndFailedAlarmToDiscord()
                }
            } // Discord Send Post ë
        } // stage('Jenkins CI/CD ì‘ì—… ì™„ë£Œ') ë
    } // stages ë
}

void sendStartAlarmToDiscord() {
    discordSend(
            title: DISCORD_SEND_MESSAGE_TITLE,
            description: "${DRIVE_ENV} í™˜ê²½ ë°°í¬ ì‘ì—… ì‹œì‘ í•©ë‹ˆë‹¤.",
            footer: "==============ë°°í¬ ì‘ì—… ì‹œì‘============\n\n"
                    + "í†µí•© ê´€ë¦¬ WAS ë°°í¬ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆì–´ìš”.\n"
                    + "${env.JOB_NAME}(${env.BUILD_NUMBER})\n\n"
                    + "Git Pull Request ID ì •ë³´ \n"
                    + "${PR_ID}\n\n"
                    + "Git Pull Request BRANCH ì •ë³´ \n"
                    + "${PR_BRANCH}\n\n"
                    + "Git COMMIT ìœ ë°œì ì •ë³´ \n"
                    + "${GIT_COMMIT_AUTHOR}\n\n"
                    + "Git COMMIT Message \n"
                    + "${GIT_COMMIT_MESSAGE}\n\n"
                    + "Build URL ì •ë³´ \n\n",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            webhookURL: DISCORD_WEBHOOK_URL
    )
}

void sendSuccessAlarmToDiscord(String stage) {
    discordSend(
            title: stage,
            description: stage + " ì‘ì—… ì„±ê³µí–ˆì–´ìš” ğŸ˜€",
            footer: "â“’ 2023. ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤(giggals.pepole@gmail.com) All Rights Reserved. Blog : https://giggal-people.tistory.com/\n",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            webhookURL: DISCORD_WEBHOOK_URL
    )
}

void sendFailedAlarmToDiscord(String stage) {
    discordSend(
            title: stage,
            description: stage + " ì‘ì—… ì‹¤íŒ¨ í–ˆì–´ìš” ğŸ˜¤",
            footer: "â“’ 2023. ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤(giggals.pepole@gmail.com) All Rights Reserved. Blog : https://giggal-people.tistory.com/\n",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            webhookURL: DISCORD_WEBHOOK_URL
    )
}

void sendEndSuccessAlarmToDiscord() {
    discordSend(
            title: DISCORD_SEND_MESSAGE_TITLE,
            description: "${DRIVE_ENV} í™˜ê²½ ë°°í¬ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ëë‚¬ì–´ìš”.",
            footer: "==============ë°°í¬ ì‘ì—… ë============\n"
                    + "â“’ 2023. ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤(giggals.pepole@gmail.com) All Rights Reserved. Blog : https://giggal-people.tistory.com/\n\n",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            webhookURL: DISCORD_WEBHOOK_URL
    )
}

void sendEndFailedAlarmToDiscord() {
    discordSend(
            title: DISCORD_SEND_MESSAGE_TITLE,
            description: "${DRIVE_ENV} í™˜ê²½ ë°°í¬ ì‘ì—…ì´ ì‹¤íŒ¨ë¡œ ëë‚¬ì–´ìš”.",
            footer: "==============ë°°í¬ ì‘ì—… ë============\n"
                    + "â“’ 2023. ê¸°ê¹”ë‚˜ëŠ” ì‚¬ëŒë“¤(giggals.pepole@gmail.com) All Rights Reserved. Blog : https://giggal-people.tistory.com/\n\n",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            webhookURL: DISCORD_WEBHOOK_URL
    )
}