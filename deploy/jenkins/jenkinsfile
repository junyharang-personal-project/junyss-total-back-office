def SET_VARIABLE = "Jenkins File ë³€ìˆ˜ ì„¤ì •"
def SONARQUBE_ANALYSIS = "ì†Œë‚˜íë¸Œ Analysis í™•ì¸"
def SONARQUBE_QUALITY_GATE = "ì†Œë‚˜íë¸Œ Quality Gate í™•ì¸"

pipeline {
    agent any
    environment {
        WEBHOOK_URL = credentials("Total-Back-Office-BE-Discord-Webhook")
    }

    stages {
        stage('Project Build ì‘ì—…') {
            steps {
                sh '''
                    echo 'Project Build ì‘ì—…ì„ ì‹œì‘ í•©ë‹ˆë‹¤!'
                    ./gradlew clean build --stacktrace --warning-mode all --info
                '''
            }

            post {
                success {
                    discordSend description: "Project Build ì‘ì—… ì„±ê³µ í•˜ì˜€ì–´ìš”. ğŸ˜€",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }

                failure {
                    discordSend description: "Project Build ì‘ì—… ì‹¤íŒ¨ í•˜ì˜€ì–´ìš”. ğŸ˜¢",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }
            } // Discord Send Post ë
        } // stage('Project Build ì‘ì—…') ë

        stage(SET_VARIABLE) {
            steps {
                script {
                    // êµ¬ë™ í™˜ê²½ ì„¤ì • (ì‚¼í•­ ì—°ì‚°ìë¡œ ë¸ŒëŸ°ì¹˜ ì´ë¦„ì´ masterë¼ë©´ prod í™˜ê²½ì´ê³ , ì•„ë‹ˆë©´ dev í™˜ê²½
                    DRIVE_ENV = env.BRANCH_NAME.equals("master") ? "prod" : "dev"

                    // ì†Œë‚˜íë¸Œ ì„¤ì •
                    SONARQUBE_SERVER_NAME = 'SonarQube_BackEnd'
//                    SONARQUBE_PR_SERVER_NAME = "Giggal_BE_SonarBot"
                    SONARQUBE_CREDENTIAL_ID = "Total-Back-Office-BE-SonarQube"

                    // TEST Coverage Report Path
                    JUNIT_REPORT_PATH = "build/test-results/test"
                    JACOCO_REPORT_PATH = "build/jacoco/jacoco.xml"
                    CHECKSTYLE_REPORT_PATH = "build/reports/checkstyle-output/checkstyle-report.xml"
                }
            }
        } // stage(SET_VARIABLE) ë

        stage(SONARQUBE_ANALYSIS) {
            when {
                branch pattern: "(develop|master)", comparator: "REGEXP"
            }

            steps {
                script {
                    def scannerHome = tool 'SonarQube-Scanner';
                    withSonarQubeEnv(credentialsId: SONARQUBE_CREDENTIAL_ID, installationName: SONARQUBE_SERVER_NAME) {
                        sh "${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=BE-total-back-office \
                        -Dsonar.projectName=BE-total-back-office \
                        -Dsonar.branch.name=master \
                        -Dsonar.language=java \
                        -Dsonar.java.source=1.8 \
                        -Dsonar.sources=src/main/java \
                        -Dsonar.test=src/test/java \
                        -Dsonar.test.inclusion=**/*Test.java \
                        -Dsonar.issuesReport.console.enable=true \
                        -Dsonar.junit.reportPaths=${JUNIT_REPORT_PATH} \
                        -Dsonar.java.binaries=build/classes \
                        -Dsonar.java.coveragePlugin=jacoco \
                        -Dsonar.coverage.jacoco.xmlReportPaths=${JACOCO_REPORT_PATH} \
                        -Dsonar.java.libraries.empty=true \
                        -Dsonar.sourceEncoding=UTF-8 \
                        -Dsonar.java.checkstyle.reportPaths=${CHECKSTYLE_REPORT_PATH} \
                        -Dsonar.exclusions=**/dto/**,**/exception/**,**/constant/**,**/SpringInitProjectApplication.java,**/WebRestController.java,**/FileUploadYaml.java \
                        "
                    }
                }
            }

            post {
                success {
                    discordSend description: "ì†Œë‚˜íë¸Œ Scan ì‘ì—… ì„±ê³µ í•˜ì˜€ì–´ìš”. ğŸ˜€",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }

                failure {
                    discordSend description: "ì†Œë‚˜íë¸Œ Scan ì‘ì—… ì‹¤íŒ¨ í•˜ì˜€ì–´ìš”. ğŸ˜¢",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }
            } // Discord Send Post ë
        } // stage(SONARQUBE_ANALYSIS) ë

        stage(SONARQUBE_QUALITY_GATE) {
            when {
                branch pattern: "(develop|master)", comparator: "REGEXP"
            }

            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
//                    script {
//                        echo "ì†Œë‚˜íë¸Œ Quality Gate ê²€ì‚¬ê°€ ì‹œì‘ ë˜ì—ˆì–´ìš”!"
//                        def sonarQubeQualityGate = waitForQualityGate()
//                        def qualityGateStatus = sonarQubeQualityGate.status
//                        echo "Quality Gate ìƒíƒœ: ${qualityGateStatus}"
//
//                        if (qualityGateStatus != 'OK') {
//                            echo "Quality Gate ê²€ì¦ ìƒíƒœ: ${qualityGateStatus}"
//                            error "Quality Gate ê²€ì¦ì— ì‹¤íŒ¨ í•˜ì˜€ì–´ìš” ğŸ˜­: ${qualityGateStatus}"
//
//                        } else {
//                            echo "Quality Gate ê²€ì¦ì— ì„±ê³µ í•˜ì˜€ì–´ìš” ğŸ˜€: ${qualityGateStatus}"
//                        }
//
//                        echo "Quality Gate ê²€ì¦ì„ ëª¨ë‘ ì™„ë£Œ í•˜ì˜€ì–´ìš” ğŸ˜"
//                    }
                }
            }

            post {
                success {
                    discordSend description: "ì†Œë‚˜íë¸Œ Quality Gate ì‘ì—… ì„±ê³µ í•˜ì˜€ì–´ìš”. ğŸ˜€",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }

                failure {
                    discordSend description: "ì†Œë‚˜íë¸Œ Quality Gate ì‘ì—… ì‹¤íŒ¨ í•˜ì˜€ì–´ìš”. ğŸ˜¢",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }
            } // Discord Send Post ë
        } // stage(SONARQUBE_QUALITY_GATE) ë

        stage('Jenkins CI/CD ì‘ì—… ì™„ë£Œ') {
            steps {
                sh 'echo "Jenkins CI/CD ì‘ì—…ì´ ì™„ë£Œ ë˜ì—ˆì–´ìš”. ğŸ˜"'
            }

            post {
                success {
                    discordSend description: "Build ì„±ê³µ í•˜ì˜€ì–´ìš”. ğŸ˜€",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }

                failure {
                    discordSend description: "Build ì‹¤íŒ¨ í•˜ì˜€ì–´ìš”. ğŸ˜¢",
                            footer: "Jenkins CI/CD Trigger Alarm",
                            link: env.BUILD_URL, result: currentBuild.currentResult,
                            title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                            webhookURL: env.WEBHOOK_URL
                }
            } // Discord Send Post ë
        } // stage('Jenkins CI/CD ì‘ì—… ì™„ë£Œ') ë
    } // stages ë
}