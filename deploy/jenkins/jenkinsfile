def SET_VARIABLE = "Jenkins File ë³€ìˆ˜ ì„¤ì •"
def SONARQUBE_ANALYSIS = "ì†Œë‚˜íë¸Œ Analysis í™•ì¸"
def SONARQUBE_QUALITY_GATE = "ì†Œë‚˜íë¸Œ Quality Gate í™•ì¸"

pipeline {
    agent any
    environment {
        WEBHOOK_URL = credentials("Total-Back-Office-BE-Discord-Webhook")
    }

    stages {
        stage(SET_VARIABLE) {
            steps {
                script {
                    // êµ¬ë™ í™˜ê²½ ì„¤ì • (ì‚¼í•­ ì—°ì‚°ìë¡œ ë¸ŒëŸ°ì¹˜ ì´ë¦„ì´ masterë¼ë©´ prod í™˜ê²½ì´ê³ , ì•„ë‹ˆë©´ dev í™˜ê²½
                    DRIVE_ENV = env.BRANCH_NAME.equals("master") ? "prod" : "dev"

                    // ì†Œë‚˜íë¸Œ ì„¤ì •
                    SONARQUBE_SERVER_NAME = 'Jenkins SonarQube Server ì„¤ì •ì˜ Name'
                    SONARQUBE_PR_SERVER_NAME = "Giggal_BE_SonarBot"
                    SONARQUBE_CREDENTIAL_ID = "Jenkinsì—ì„œ ë“±ë¡í•œ SonarQube Crendential ID"
                }
            }
        } // stage(SET_VARIABLE) ë

        stage(SONARQUBE_ANALYSIS) {
            when {
                branch pattern: "(develop|master)", comparator: "REGEXP"
            }

            steps {
                script {
                    def scannerHome = tool 'SonarQube-Scanner';
                    withSonarQubeEnv(credentialsId: SONARQUBE_CREDENTIAL_ID, installationName: SONARQUBE_SERVER_NAME) {
                    sh "${scannerHome}/bin/sonar-scanner \
                        -Dsonar.branch.name=master \
                        -Dsonar.language=java \
                        -Dsonar.java.source=1.8 \
                        -Dsonar.sources=src/main/java \
                        -Dsonar.test=src/test/java \
                        -Dsonar.test.inclusion=**/*Test.java \
                        -Dsonar.issuesReport.console.enable=true \
                        -Dsonar.junit.reportPaths=build/test-results/test \
                        -Dsonar.java.binaries=build/classes \
                        -Dsonar.java.libraries.empty=true \
                        -Dsonar.sourceEncoding=UTF-8 \
                        -Dsonar.exclusions=**/dto/**,**/exception/**,**/constant/**,**/SpringInitProjectApplication.java,**/WebRestController.java,**/FileUploadYaml.java \
                        -Dsonar.java.checkstyle.reportPaths=build/reports/checkstyle-output/checkstyle-report.xml \
                        "
                    }
                }
            }
        } // stage(SONARQUBE_ANALYSIS) ë

        stage(SONARQUBE_QUALITY_GATE) {
            when {
                branch pattern: "(feature*|develop)", comparator: "REGEXP"
            }

            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        echo "ì†Œë‚˜íë¸Œ Quality Gate ê²€ì‚¬ê°€ ì‹œì‘ ë˜ì—ˆì–´ìš”!"

                        def sonarQubeQualityGate = waitForQualityGate()
                        def qualityGateStatus = sonarQubeQualityGate.status

                        echo "Quality Gate ìƒíƒœ: ${qualityGateStatus}"

                        if (qualityGateStatus != 'OK') {
                            echo "Quality Gate ê²€ì¦ ìƒíƒœ: ${qualityGateStatus}"

                            error "Quality Gate ê²€ì¦ì— ì‹¤íŒ¨ í•˜ì˜€ì–´ìš” ğŸ˜­: ${qualityGateStatus}"

                        } else {
                         echo "Quality Gate ê²€ì¦ì— ì„±ê³µ í•˜ì˜€ì–´ìš” ğŸ˜€: ${qualityGateStatus}"
                    }

                    echo "Quality Gate ê²€ì¦ì„ ëª¨ë‘ ì™„ë£Œ í•˜ì˜€ì–´ìš” ğŸ˜"
                }
            }
        } // stage(SONARQUBE_QUALITY_GATE) ë

        post {
            success {
                discordSend description: "Build ì„±ê³µ í•˜ì˜€ì–´ìš”. ğŸ˜€",
                    footer: "Jenkins CI/CD Trigger Alarm",
                    link: env.BUILD_URL, result: currentBuild.currentResult,
                    title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                    webhookURL: env.WEBHOOK_URL
            }

            failure {
                discordSend description: "Build ì‹¤íŒ¨ í•˜ì˜€ì–´ìš”. ğŸ˜¢",
                    footer: "Jenkins CI/CD Trigger Alarm",
                    link: env.BUILD_URL, result: currentBuild.currentResult,
                    title: "Jenkins CI/CD Trigger Discordë¥¼ í†µí•´ ë°›ê¸° ì‹œí—˜ ì¤‘ ì…ë‹ˆë‹¤.",
                    webhookURL: env.WEBHOOK_URL
            }
        }
    }
}
